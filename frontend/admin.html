<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Librarian Dashboard | Nima Library</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
    <style>
        /* Admin Specific Styles */
        .admin-header { 
            background: linear-gradient(135deg, #c0392b, #e74c3c); 
            color: white; 
            padding: 25px; 
            border-radius: 10px; 
            margin-bottom: 20px; 
            box-shadow: 0 4px 15px rgba(192, 57, 43, 0.3);
        }
        .admin-header h1 { font-size: 24px; margin-bottom: 5px; }
        
        .booking-table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 14px; }
        .booking-table th { background: #f8f9fa; padding: 12px; text-align: left; font-weight: 600; color: #2c3e50; border-bottom: 2px solid #eee; }
        .booking-table td { padding: 12px; border-bottom: 1px solid #eee; color: #555; vertical-align: middle; }
        .booking-table tr:hover { background-color: #fafafa; }
        
        .delete-btn {
            background: #ffebee; color: #c0392b; border: 1px solid #c0392b;
            padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; font-weight: 500;
            transition: 0.2s;
        }
        .delete-btn:hover { background: #c0392b; color: white; }

        /* Login Overlay */
        #loginOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(44, 62, 80, 0.95); z-index: 999;
            display: flex; justify-content: center; align-items: center;
        }
        .login-box { background: white; padding: 40px; border-radius: 10px; text-align: center; width: 320px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        .login-box input { width: 100%; padding: 12px; margin: 15px 0; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box; }
        .login-status { margin-top: 10px; font-size: 13px; color: #e74c3c; min-height: 20px;}
    </style>
</head>
<body>

<div id="loginOverlay">
    <div class="login-box">
        <i class="fa-solid fa-user-shield" style="font-size: 40px; color: #c0392b; margin-bottom: 15px;"></i>
        <h2 style="margin: 0; color: #2c3e50;">Admin Login</h2>
        <p style="color: #7f8c8d; font-size: 14px; margin-top: 5px;">Restricted Access</p>
        
        <input type="password" id="adminPass" placeholder="Enter Admin Password">
        <button class="main-btn" onclick="checkLogin()" style="width: 100%;">Access Dashboard</button>
        <div class="login-status" id="loginStatus"></div>
    </div>
</div>

<div class="main-wrapper">
    <div class="container" style="max-width: 1000px;">
        
        <div class="admin-header">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <h1><i class="fa-solid fa-shield-halved"></i> Librarian Dashboard</h1>
                    <p style="margin:0; opacity: 0.9;">Manage reservations and monitor library usage</p>
                </div>
                <div style="text-align: right;">
                    <button class="main-btn" style="background: rgba(255,255,255,0.2); border: 1px solid white; font-size: 13px; padding: 8px 15px;" onclick="window.location.reload()">
                        <i class="fa-solid fa-arrow-right-from-bracket"></i> Logout
                    </button>
                </div>
            </div>
        </div>

        <div class="card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h3 style="margin:0;"><i class="fa-solid fa-list"></i> All Active Bookings</h3>
                <button class="main-btn" style="width: auto; padding: 8px 15px; font-size: 14px;" onclick="loadAllBookings()">
                    <i class="fa-solid fa-rotate"></i> Refresh List
                </button>
            </div>

            <div style="overflow-x: auto;">
                <table class="booking-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Time Slot</th>
                            <th>Room</th>
                            <th>Student Leader</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="adminTableBody">
                        <tr><td colspan="5" style="text-align:center; padding: 30px; color: #888;">Waiting for login...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div style="text-align: center; margin-top: 30px;">
            <a href="index.html" style="color: #666; text-decoration: none; font-size: 14px;">
                <i class="fa-solid fa-arrow-left"></i> Return to Student View
            </a>
        </div>

    </div>
</div>

<script>
    // ✅ VERIFY THIS LINK
    const BACKEND_URL = "https://nima-backend.vercel.app"; 

    // 1. SECURE LOGIN
    async function checkLogin() {
        const pass = document.getElementById("adminPass").value;
        const btn = document.querySelector(".login-box button");
        const status = document.getElementById("loginStatus");
        
        btn.innerText = "Verifying...";
        btn.disabled = true;
        status.innerText = "";

        try {
            const res = await fetch(`${BACKEND_URL}/admin-login`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ password: pass })
            });

            const result = await res.json();

            if (result.status === "success") {
                // Login Success
                document.getElementById("loginOverlay").style.display = "none";
                loadAllBookings();
            } else {
                // Login Failed
                status.innerText = "❌ " + result.message;
                btn.innerText = "Access Dashboard";
                btn.disabled = false;
            }
        } catch (err) {
            console.error(err);
            status.innerText = "❌ Server Error. Check connection.";
            btn.innerText = "Access Dashboard";
            btn.disabled = false;
        }
    }

    // 2. LOAD DATA
    async function loadAllBookings() {
        const tbody = document.getElementById("adminTableBody");
        tbody.innerHTML = `<tr><td colspan="5" style="text-align:center; padding:30px;">Loading data...</td></tr>`;

        try {
            const res = await fetch(`${BACKEND_URL}/admin/all-bookings`);
            const data = await res.json();
            
            tbody.innerHTML = ""; 

            if (data.bookings && data.bookings.length > 0) {
                // Sort by Date (Newest bookings on top)
                data.bookings.sort((a, b) => new Date(b.date) - new Date(a.date));

                data.bookings.forEach(b => {
                    const row = `
                        <tr>
                            <td>${b.date}</td>
                            <td>${b.time_slot}</td>
                            <td><span style="color: #2980b9; font-weight: bold; background: #eaf2f8; padding: 3px 8px; border-radius: 4px;">${b.room_id}</span></td>
                            <td>
                                <strong>${b.leader}</strong><br>
                                <span style="font-size: 12px; color: #888;">${b.roll_no}</span>
                            </td>
                            <td>
                                <button class="delete-btn" onclick="deleteBooking('${b.room_id}', '${b.date}', '${b.time_slot}')">
                                    <i class="fa-solid fa-trash"></i> Cancel
                                </button>
                            </td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                });
            } else {
                tbody.innerHTML = `<tr><td colspan="5" style="text-align:center; padding:30px; color:#888;">No active bookings found.</td></tr>`;
            }
        } catch (err) {
            console.error(err);
            tbody.innerHTML = `<tr><td colspan="5" style="text-align:center; color:red; padding:30px;">Error loading data. Is Backend running?</td></tr>`;
        }
    }

    // 3. DELETE BOOKING
    async function deleteBooking(roomId, date, timeSlot) {
        if (!confirm(`⚠️ WARNING: Are you sure you want to cancel the booking for Room ${roomId}? This cannot be undone.`)) return;

        try {
            const res = await fetch(`${BACKEND_URL}/cancel-booking`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ room_id: roomId, date: date, time_slot: timeSlot })
            });
            
            const result = await res.json();
            if (result.status === "success") {
                alert("✅ Booking Cancelled Successfully!");
                loadAllBookings(); // Refresh table immediately
            } else {
                alert("Error: " + result.message);
            }
        } catch (err) {
            alert("Failed to delete.");
        }
    }
    
    // Allow pressing "Enter" to login
    document.getElementById("adminPass").addEventListener("keypress", function(event) {
        if (event.key === "Enter") {
            checkLogin();
        }
    });
</script>
</body>
</html>